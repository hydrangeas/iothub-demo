# インフラストラクチャ - Terraformによる実装

## インフラストラクチャ構成

MachineLog.Infrastructureは、Terraformを使用してAzureリソースをコードとして管理するプロジェクトです。以下の主要コンポーネントを含む構造で設計してください：

- **Terraformモジュール**: 再利用可能なインフラストラクチャコンポーネント
- **環境別設定**: 開発、テスト、本番環境ごとの設定
- **変数定義**: 環境やデプロイごとに変更可能な変数
- **出力値**: デプロイ後に他のシステムで使用する値
- **バックエンド設定**: 状態ファイルの保存先設定

## Terraformモジュール構成

### Azure Monitor Logsモジュール

Log Analyticsワークスペースとデータ収集ルールを作成するモジュールを実装してください。このモジュールには、Log Analyticsワークスペース、データ収集ルール、データ収集エンドポイント、保存クエリ、アラートルールなどのリソースを含めます。

### Azure Storageモジュール

長期保存用のストレージアカウントを作成するモジュールを実装してください。このモジュールには、ストレージアカウント、BLOBコンテナ、ライフサイクル管理ポリシー、アクセスポリシーなどのリソースを含めます。

### Azure App Serviceモジュール

Webアプリケーションをホストするためのリソースを作成するモジュールを実装してください。このモジュールには、App Serviceプラン、App Service、アプリケーション設定、診断設定などのリソースを含めます。

### Microsoft Entra IDモジュール

認証と認可のためのリソースを作成するモジュールを実装してください。このモジュールには、アプリケーション登録、サービスプリンシパル、アプリケーションロール、APIアクセス許可などのリソースを含めます。

## 環境別設定

### 開発環境

開発環境用の設定を実装してください。リソースグループ名は「rg-machinelog-dev」とし、単一リージョンにデプロイします。コスト最適化のため低コストのSKUを使用し、ログ保持期間は30日に設定します。また、デバッグ設定を有効化してください。

### テスト環境

テスト環境用の設定を実装してください。リソースグループ名は「rg-machinelog-test」とし、単一リージョンにデプロイします。本番環境と同等のSKUを使用し、ログ保持期間は90日に設定します。負荷テスト用の設定も含めてください。

### 本番環境

本番環境用の設定を実装してください。リソースグループ名は「rg-machinelog-prod」とし、主要リージョンにデプロイします。高性能・高可用性のSKUを使用し、ログ保持期間は365日に設定します。バックアップとディザスタリカバリの設定も含めてください。

## Terraform実装上の考慮事項

### モジュール設計

再利用可能なモジュールを設計し、適切な入力変数と出力値を定義してください。デフォルト値を提供し、バリデーションルールを実装して設定ミスを防止します。

### 状態管理

Terraformの状態をAzure Storageに保存し、状態ファイルのロック機構を実装してください。状態のバックアップと暗号化も設定します。

### セキュリティ

Azure Key Vaultを使用してシークレットを管理し、最小権限の原則に基づいてIAM設定を行います。プライベートエンドポイントを使用してネットワークセキュリティを確保し、監査ログを有効化してください。

### CI/CD統合

GitHub ActionsまたはAzure DevOpsとTerraformを統合し、自動プラン生成と適用を設定してください。承認ワークフローとデプロイ前の自動検証も実装します。

### ベストプラクティス

命名規則の一貫性を保ち、リソースにタグ付けを標準化してください。terraform fmtを使用してコードフォーマットを統一し、terraform-docsでドキュメントを生成します。

## 主要リソース

### Log Analyticsワークスペース

環境ごとに適切な名前、SKU、保持期間を設定したLog Analyticsワークスペースを作成します。

### データ収集ルール

カスタムログを収集するためのデータ収集ルールを作成し、適切なデータフローを設定します。

### ストレージアカウント

長期ログ保存用のストレージアカウントを作成し、ライフサイクル管理ポリシーを設定してコスト最適化を図ります。

### App Service

WebアプリケーションをホストするためのApp Serviceを作成し、適切なアプリケーション設定と診断設定を構成します。

### Microsoft Entra ID設定

認証と認可のためのアプリケーション登録とサービスプリンシパルを作成し、必要なAPIアクセス許可を設定します。
