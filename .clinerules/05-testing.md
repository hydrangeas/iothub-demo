# テスト戦略

## テスト構造

プロジェクトのテストは以下の構造で実装してください：

- **MachineLog.Tests.Unit**: 単体テストプロジェクト
- **MachineLog.Tests.Integration**: 統合テストプロジェクト
- **MachineLog.Tests.Performance**: パフォーマンステストプロジェクト

## テストフレームワークとツール

- **xUnit**: テストフレームワーク
- **Moq**: モックフレームワーク
- **FluentAssertions**: アサーションライブラリ
- **Bogus**: テストデータ生成
- **coverlet**: コードカバレッジ
- **BenchmarkDotNet**: パフォーマンステスト

## 単体テスト要件

### テスト対象

以下のコンポーネントに対する単体テストを実装してください：

1. **MachineLog.Common**
   - モデルクラス
   - 検証ロジック
   - 拡張メソッド
   - ユーティリティクラス

2. **MachineLog.Collector**
   - サービスクラス
   - ユーティリティクラス
   - 設定クラス

3. **MachineLog.Monitor**
   - サービスクラス
   - コンポーネントロジック

### テスト原則

- 各テストは単一の機能や動作に焦点を当てる
- テスト間の依存関係を避ける
- テストデータは固定値ではなくランダム生成を活用
- モックを使用して外部依存関係を分離
- 境界値と異常系のテストを含める

### テスト命名規則

テストメソッドの命名は以下の規則に従ってください：
`[テスト対象メソッド]_[テスト条件]_[期待される結果]`

例：

- `Serialize_ValidObject_ReturnsJsonString`
- `ProcessLog_NullInput_ThrowsArgumentNullException`
- `CalculateSize_EmptyBatch_ReturnsZero`

## 統合テスト要件

### テスト対象

以下のシナリオに対する統合テストを実装してください：

1. **ファイル監視とログ処理**
   - ファイル変更検知からログ処理までの一連のフロー
   - 複数ファイルの同時処理

2. **Azure Monitor Logs API連携**
   - 認証からデータ送信までの一連のフロー
   - エラー時のリトライ動作

3. **クエリとデータ取得**
   - Log Analyticsクエリの実行
   - 結果の処理とマッピング

### テスト環境

- テスト用のAzureリソース（テスト用ワークスペース）
- モックサーバー（必要に応じて）
- Docker環境（必要に応じて）

### テスト原則

- 実際のファイルシステムとの連携をテスト
- 実際のAPIエンドポイントとの連携をテスト（可能な場合）
- テスト後のクリーンアップを確実に実行
- 環境変数やテスト設定ファイルを使用

## パフォーマンステスト要件

### テスト対象

以下のシナリオに対するパフォーマンステストを実装してください：

1. **大量ログ処理**
   - 1万件以上のログエントリの処理時間
   - メモリ使用量

2. **並行ファイル監視**
   - 複数ファイルの同時監視時のCPU使用率
   - イベント処理のレイテンシ

3. **ネットワーク回復力**
   - 接続障害時のバッファリング性能
   - 再接続後の一括送信性能

### パフォーマンス基準

- ログ処理: 1000件/秒以上
- メモリ使用量: 最大200MB以下
- CPU使用率: 平均30%以下
- レイテンシ: 平均100ms以下

## テストカバレッジ目標

- **MachineLog.Common**: 90%以上
- **MachineLog.Collector**: 80%以上
- **MachineLog.Monitor**: 70%以上

## テスト自動化

- CI/CDパイプラインでの自動テスト実行
- プルリクエスト時の単体テスト自動実行
- 夜間ビルドでの統合テスト・パフォーマンステスト実行
- テスト結果とカバレッジレポートの自動生成

## テストデータ管理

- テストデータ生成ユーティリティの実装
- テストフィクスチャの共有
- シナリオベースのテストデータセット
- 大規模テストデータの効率的な生成方法

## モック戦略

- 外部依存関係（Azure API、ファイルシステム）のモック
- インターフェースベースのモック
- テスト用の実装クラス（必要に応じて）
- モックの再利用性を高める設計
